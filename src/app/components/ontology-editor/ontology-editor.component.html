<div class="ontology-editor">
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="tab-buttons" role="tablist">
        <button
          type="button"
          role="tab"
          class="tab-btn"
          [class.active]="activeTab() === 'tree'"
        >
          Ontology
        </button>
      </div>
      @if (activeTab() === 'tree') {
        <div class="tree-actions">
          <button
            type="button"
            class="btn btn-primary btn-icon"
            (click)="onAddTerm()"
            aria-label="Add new term"
            title="Add term as child of selected, or as root"
          >
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
          </button>
        </div>
      }
    </div>

    @if (activeTab() === 'tree') {
      <div class="search-box">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        <input
          type="search"
          placeholder="Search terms..."
          [value]="searchQuery()"
          (input)="onSearch($event)"
          aria-label="Search ontology terms"
        />
      </div>

      <div class="tree-container">
        @if (filteredTerms(); as filtered) {
          <!-- Flat search results -->
          <div class="search-results" role="listbox">
            @for (term of filtered; track term.id) {
              <button
                type="button"
                class="term-item"
                [class.selected]="selectedTermId() === term.id"
                (click)="onSelectTerm(term.id)"
                role="option"
                [attr.aria-selected]="selectedTermId() === term.id"
              >
                <span class="term-id">{{ term.id }}</span>
                <span class="term-name">{{ term.name }}</span>
                @if (getMappingsCount(term.id) > 0) {
                  <span class="badge badge-accent">
                    {{ getMappingsCount(term.id) }}
                  </span>
                }
              </button>
            } @empty {
              <p class="empty-message">No terms match "{{ searchQuery() }}"</p>
            }
          </div>
        } @else {
          <!-- Tree view -->
          <app-ontology-tree
            [terms]="rootTerms()"
            [selectedId]="selectedTermId()"
            (selectTerm)="onSelectTerm($event)"
            (moveTerm)="onMoveTerm($event)"
          />
        }
      </div>

      <div class="sidebar-footer">
        <span class="item-count">
          {{ allTerms().length }} terms
        </span>
      </div>
    }
  </aside>

  <main class="editor-content">
    @if (activeTab() === 'tree') {
      <section class="hierarchy-panel">
        <h2>Ontology hierarchy</h2>
        <p class="hint">
          Drag and drop terms to change the hierarchy. Drop on a term to make it a child,
          or drop on the “Drop here to make root” area to make it a top-level term.
        </p>

        @if (selectedTerm() || isCreating()) {
          <div class="selected-term" role="region" aria-label="Selected term">
            <div class="selected-term-header">
              <h3>
                @if (isCreating()) {
                  New category
                } @else {
                  {{ selectedTerm()?.name || selectedTerm()?.id }}
                }
              </h3>
              @if (!isCreating() && selectedTerm()) {
                <span class="term-id">{{ selectedTerm()!.id }}</span>
              }
            </div>
            @if (!isCreating() && selectedTerm()) {
              <div class="selected-term-meta">
                <span>Parents: {{ selectedTerm()!.getParents().length }}</span>
                <span>Children: {{ selectedTerm()!.getChildren().length }}</span>
              </div>
            }
            @if (isCreating() && createParentId()) {
              <p class="term-parent">Parent: {{ createParentId() }}</p>
            }
            <div class="term-edit">
              <div class="form-group">
                <label for="term-name">Name *</label>
                <input
                  id="term-name"
                  type="text"
                  [value]="draftName()"
                  (input)="onNameInput($event)"
                  placeholder="Category name"
                  required
                />
                @if (formTouched() && !draftName().trim()) {
                  <p class="field-error">Name is required.</p>
                }
              </div>
              <div class="form-group">
                <label for="term-def">Description *</label>
                <textarea
                  id="term-def"
                  rows="4"
                  [value]="draftDefinition()"
                  (input)="onDefinitionInput($event)"
                  placeholder="Short definition"
                  required
                ></textarea>
                @if (formTouched() && !draftDefinition().trim()) {
                  <p class="field-error">Description is required.</p>
                }
              </div>
              <div class="form-actions">
                <button
                  type="button"
                  class="btn btn-primary"
                  (click)="onSaveTerm()"
                  [disabled]="!isFormValid()"
                  [attr.aria-disabled]="!isFormValid()"
                >
                  @if (isCreating()) { Create category } @else { Save changes }
                </button>
                @if (!isCreating() && selectedTerm()) {
                  <button
                    type="button"
                    class="btn btn-danger"
                    (click)="onDeleteTerm()"
                  >
                    Delete
                  </button>
                }
                @if (isCreating()) {
                  <button
                    type="button"
                    class="btn btn-ghost"
                    (click)="onCancelCreate()"
                  >
                    Cancel
                  </button>
                }
              </div>
            </div>
          </div>
        } @else {
          <div class="empty-editor">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="2" y1="12" x2="22" y2="12"></line>
              <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
            </svg>
            <h3>Select a term</h3>
            <p>Pick a term to view details, then drag it to change its parent.</p>
          </div>
        }
      </section>
    }
  </main>
</div>
